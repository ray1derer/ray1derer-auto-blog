name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2
    
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ubuntu
        EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        # SSH í‚¤ ì„¤ì •
        echo "$EC2_KEY" > deploy_key.pem
        chmod 600 deploy_key.pem
        
        # í”„ë¡œì íŠ¸ ì••ì¶•
        tar -czf deploy.tar.gz \
          --exclude='node_modules' \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='.next' \
          --exclude='.env.local' \
          --exclude='*.log' \
          .
        
        # EC2ë¡œ íŒŒì¼ ì „ì†¡
        scp -o StrictHostKeyChecking=no -i deploy_key.pem \
          deploy.tar.gz $EC2_USER@$EC2_HOST:~/
        
        # EC2ì—ì„œ ë°°í¬ ì‹¤í–‰
        ssh -o StrictHostKeyChecking=no -i deploy_key.pem $EC2_USER@$EC2_HOST << 'EOF'
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
          cd ray1derer-auto-blog 2>/dev/null && docker-compose down -v || true
          docker system prune -af || true
          
          # ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì‚­ì œ
          sudo rm -rf ray1derer-auto-blog
          
          # ìƒˆ ë””ë ‰í† ë¦¬ ìƒì„± ë° ì••ì¶• í•´ì œ
          mkdir ray1derer-auto-blog
          tar -xzf deploy.tar.gz -C ray1derer-auto-blog
          cd ray1derer-auto-blog
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          cat > .env << EOL
          NODE_ENV=production
          DATABASE_URL=postgresql://localhost:5432/ray1derer_blog
          NEXT_PUBLIC_APP_URL=http://${{ secrets.EC2_HOST }}
        EOL
          
          # Docker ë¹Œë“œ ë° ì‹¤í–‰
          docker-compose build
          docker-compose up -d
          
          # ìƒíƒœ í™•ì¸
          docker-compose ps
          
          # ì •ë¦¬
          cd ..
          rm deploy.tar.gz
        EOF
        
        # ë¡œì»¬ ì •ë¦¬
        rm deploy_key.pem deploy.tar.gz
    
    - name: Health check
      run: |
        sleep 30
        curl -f http://${{ secrets.EC2_HOST }}:3000 || exit 1
        echo "Deployment successful! ğŸ‰"